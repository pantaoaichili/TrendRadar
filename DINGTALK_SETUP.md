# 钉钉通知渠道配置指南

## 📋 配置步骤

### 步骤 1: 创建钉钉机器人（仅 PC 端支持）

⚠️ **注意**：钉钉移动端只能接收消息，无法创建新机器人，必须在 PC 端操作。

1. **打开钉钉 PC 客户端**
   - 下载地址：https://www.dingtalk.com/download

2. **进入目标群聊**
   - 选择你要接收通知的群聊（如果没有群，先创建一个）

3. **打开群设置**
   - 点击群聊右上角的设置图标（⚙️）
   - 往下翻找到 **"机器人"** 选项，点击进入

4. **添加自定义机器人**
   - 点击 **"添加机器人"**
   - 选择 **"自定义"** 类型

5. **配置机器人**
   - **机器人名称**：输入名称（如 "TrendRadar 热点监控"）
   - **安全设置**：
     - 选择 **"自定义关键词"**
     - 输入关键词：`热点`（必须包含这个词，否则消息会被过滤）
   - 勾选服务条款协议

6. **完成设置**
   - 点击 **"完成"**
   - 复制获得的 **Webhook URL**
   - ⚠️ **重要**：Webhook URL 只显示一次，请立即复制保存

### 步骤 2: 配置到 GitHub Secrets

1. **进入 GitHub 仓库设置**
   - 访问：https://github.com/maverikhe-cpu/TrendRadar/settings/secrets/actions
   - 或：`Settings` → `Secrets and variables` → `Actions`

2. **添加 Secret**
   - 点击 **"New repository secret"** 按钮
   - **Name（名称）**：`DINGTALK_WEBHOOK_URL`
     - ⚠️ **必须严格一致**，不能自己修改或打错
     - 建议直接复制粘贴，不要手打
   - **Secret（值）**：粘贴刚才复制的钉钉 Webhook URL
   - 点击 **"Add secret"**

3. **验证配置**
   - 保存后，在 Secrets 列表中应该能看到 `DINGTALK_WEBHOOK_URL`
   - ⚠️ 注意：保存后无法查看值的内容，这是正常的安全机制

### 步骤 3: 测试配置

1. **手动触发工作流**
   - 访问：https://github.com/maverikhe-cpu/TrendRadar/actions
   - 找到 **"Hot News Crawler"** 工作流
   - 点击 **"Run workflow"** → **"Run workflow"**

2. **等待执行**
   - 通常需要 1-3 分钟
   - 可以在 Actions 页面查看实时日志

3. **检查钉钉消息**
   - 如果配置正确，钉钉群聊中应该会收到热点新闻推送
   - 消息格式类似：
     ```
     📊 热点词汇统计
     
     🔥 [1/3] AI ChatGPT : 2 条
     
       1. [百度热搜] 🆕 ChatGPT-5正式发布 [**1**] - 09时15分 (1次)
     ```

---

## ⚠️ 重要注意事项

### 1. 关键词设置

钉钉机器人必须设置自定义关键词：`热点`

- ✅ **正确**：消息标题包含 "热点" 关键词
- ❌ **错误**：消息标题不包含 "热点"，会被钉钉过滤

**为什么需要关键词？**
- 钉钉的安全机制，防止机器人被滥用
- 项目会自动在消息中包含 "热点" 关键词，所以不用担心

### 2. Webhook URL 安全

- 🔴 **不要公开** Webhook URL
- 🔴 **不要提交**到代码仓库
- ✅ **只放在** GitHub Secrets 中
- ✅ 如果泄露，立即在钉钉中删除并重新创建机器人

### 3. 消息长度限制

钉钉单条消息有长度限制（约 20KB），项目已自动实现分批推送：
- 如果内容过长，会自动拆分为多条消息发送
- 每条消息之间有 3 秒间隔

---

## 🔍 故障排查

### 问题 1: 没有收到推送消息

**检查清单**：
- [ ] 是否配置了 `DINGTALK_WEBHOOK_URL` Secret？
- [ ] Secret 名称是否正确（严格一致：`DINGTALK_WEBHOOK_URL`）？
- [ ] Webhook URL 是否正确（以 `https://oapi.dingtalk.com/robot/send?access_token=` 开头）？
- [ ] 工作流是否成功执行（查看 Actions 日志）？
- [ ] 是否有匹配关键词的新闻（检查 `frequency_words.txt`）？

**查看日志**：
1. 进入 Actions 页面
2. 点击最近的工作流运行
3. 查看 "Run crawler" 步骤的日志
4. 查找是否有钉钉相关的错误信息

### 问题 2: 收到 "关键词不匹配" 错误

**原因**：钉钉机器人设置了自定义关键词，但消息中没有包含该关键词

**解决**：
- 确认机器人安全设置中的关键词是 `热点`
- 项目会自动在消息中包含 "热点" 关键词
- 如果仍有问题，检查 Webhook URL 是否正确

### 问题 3: 工作流执行失败

**查看错误日志**：
1. 进入 Actions 页面
2. 点击失败的工作流
3. 查看具体的错误信息

**常见错误**：
- **"配置文件不存在"**：检查 `config/config.yaml` 是否存在
- **"依赖安装失败"**：检查网络连接
- **"未配置通知渠道"**：确认已添加 `DINGTALK_WEBHOOK_URL` Secret

---

## 📱 钉钉消息效果预览

配置成功后，你会收到类似这样的消息：

```
📊 热点词汇统计

🔥 [1/3] AI ChatGPT : 2 条

  1. [百度热搜] 🆕 ChatGPT-5正式发布 [**1**] - 09时15分 (1次)

  2. [今日头条] AI芯片概念股暴涨 [**3**] - [08时30分 ~ 10时45分] (3次)

━━━━━━━━━━━━━━━━━━━

📈 [2/3] 比亚迪 特斯拉 : 2 条

  1. [微博] 🆕 比亚迪月销量破纪录 [**2**] - 10时20分 (1次)

  2. [抖音] 特斯拉降价促销 [**4**] - [07时45分 ~ 09时15分] (2次)

🆕 本次新增热点新闻 (共 2 条)

更新时间：2025-01-15 12:30:15
```

---

## 🔄 重新配置机器人

如果需要更换机器人或 Webhook URL：

1. **删除旧机器人**（可选）：
   - 钉钉 PC 端 → 群设置 → 机器人 → 删除旧机器人

2. **创建新机器人**：
   - 按照步骤 1 重新创建

3. **更新 GitHub Secret**：
   - 进入 GitHub Secrets 设置
   - 找到 `DINGTALK_WEBHOOK_URL`
   - 点击编辑（或删除后重新创建）
   - 更新为新的 Webhook URL

---

## ✅ 配置完成检查清单

- [ ] 钉钉机器人已创建
- [ ] 已设置自定义关键词：`热点`
- [ ] 已复制 Webhook URL
- [ ] 已在 GitHub 添加 `DINGTALK_WEBHOOK_URL` Secret
- [ ] Secret 名称正确（严格一致）
- [ ] 已手动触发工作流测试
- [ ] 收到钉钉推送消息

---

## 📚 相关资源

- [项目完整文档](README.md)
- [GitHub Actions 配置指南](GITHUB_ACTIONS_GUIDE.md)
- [钉钉开放平台文档](https://open.dingtalk.com/document/)

---

## 🆘 需要帮助？

如果遇到问题：

1. **查看工作流日志**：在 Actions 页面查看详细错误信息
2. **检查配置**：确认 Secret 名称和值都正确
3. **测试 Webhook**：可以使用 curl 测试 Webhook 是否有效：
   ```bash
   curl -H "Content-Type: application/json" \
        -d '{"msgtype":"text","text":{"content":"测试消息"}}' \
        YOUR_WEBHOOK_URL
   ```
4. **提交 Issue**：在项目 Issues 中搜索类似问题

---

**配置完成后，系统会每小时自动推送热点新闻到你的钉钉群！** 🎉

